import os
from winreg import *

class AutoRun(object):
    
    def __init__(self,main=True):
        if not main:
            self.runsFiles = self.getAutoStart()

    def __regQuery__(self,fullpath):
        path,t = fullpath[5:],fullpath[:4]
        regtypes = {
            "HKLM": HKEY_LOCAL_MACHINE,
            "HKCU": HKEY_CURRENT_USER
        }
        try:
            keyraw = OpenKey(
                ConnectRegistry(None, regtypes[t]), path
            )
        except:
            return []
        c = 0
        values = []
        try:
            while True:
                _, value,_ = EnumValue(keyraw, c)
                c += 1
                values.append(value)
        except WindowsError:
                pass
        return [i.split(os.sep)[-1] for i in values]
    
    
    def __getEx__(self,path):
        try: return [
            i for i in os.listdir(path) if os.path.isfile(os.path.join(path,i)) 
            and os.path.splitext(i)[-1] in [".exe",".ps1",".bat"]
        ]
        except: return []
        

    def getAutoStart(self):
        regstart = [
             'HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run',
             'HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce',
             'HKLM\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Run',
             'HKLM\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\RunOnce',
             'HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run',
             'HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce',
             'HKCU\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Run',
             'HKCU\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\RunOnce',
             'HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Terminal Server\\Install\\Software\\Microsoft\\Windows\\CurrentVersion\\Run',
             'HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Terminal Server\\Install\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce',
             'HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Terminal Server\\Install\\Software\\Microsoft\\Windows\\CurrentVersion\\RunE',
             'HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunServicesOnce',
             'HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\RunServicesOnce',
             'HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunServices',
             'HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\RunServices',
             'HKLM\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\RunServicesOnce',
             'HKCU\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\RunServicesOnce',
             'HKLM\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\RunServices',
             'HKCU\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\RunServices',
             'HKLM\\Software\\Microsoft\\Windows\\RunOnceEx',
             'HKLM\\Software\\Wow6432Node\\Microsoft\\Windows\\RunOnceEx',
             'HKCU\\Software\\Microsoft\\Windows\\RunOnceEx',
             'HKCU\\Software\\Microsoft\\Windows\\RunOnceEx'
        ]
        usersDirs = sum (
            [
                [os.path.join(r"C:\Users", i,r"AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup") 
                     for i in os.listdir(r"C:\Users") 
                     if os.path.isdir(os.path.join(r"C:\Users", i))
                ],
                ["C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp"]
            ],[]
        )
        
        return sum([self.__regQuery__(i) if i[0] == "H" else self.__getEx__(i) for i in regstart + usersDirs],[])


