import os
from openpyxl import Workbook
from genpayloads import GenPayloads


class GenReprt(object):
    
    def __init__(self,report,payload=True):
        self.report = report
        self.rpath = self.__genTemps__()
        self.payload = payload
        if payload:
            self.gp = GenPayloads()
        
        
    def __genTemps__(self):
        if not os.path.isdir(
            os.path.join(os.path.join(os.getcwd(),"Reports"))
        ):
            os.mkdir(os.path.join(os.getcwd(),"Reports"))
        else:
            os.remove(os.path.join(os.getcwd(),"Reports"))
            return GenReprt("").__genTemps__()
        return os.path.join(os.path.join(os.getcwd(),"Reports"))

    
    def __getsubfields__(self):
        return [
            "Dll Name",
            "User Name",
            "Technics",
            "Dll Pathes",
            "Description"
        ]
        
    def __getFields__(self,jsonData,dllname):
        return [dllname]+[jsonData[i] for i in jsonData.keys()]
    
    
    def __getpayPaths__(self,jsonData):
        return [i.strip() for i in jsonData["DllPath"].split(',')]
    
    def __getfilepathes__(self,process):
        return os.path.join(
            self.rpath,
            os.path.basename(process)+".xlsx"
        )
    
    def genReport(self):
        for i in self.report.keys():
            if self.payload:
                name = list(self.report[i].keys())
                for n in name:
                    self.gp.generate(self.report[i][n]['Technics'],self.report[i][n]["DllPath"],i)
            wb = Workbook()
            ws = wb.active
            ws.append(self.__getsubfields__())
            for n in self.report[i].keys():
                ws.append(self.__getFields__(self.report[i][n],n))
            wb.save(self.__getfilepathes__(i))
            wb.close()
        print("The full report is located on "+os.path.join(os.getcwd(),"Reports"))
        print("The full report is located on "+os.path.join(os.getcwd(),"Paylodas"))
        
        
